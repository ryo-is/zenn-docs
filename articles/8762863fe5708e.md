---
title: "Githubã®PRãŒä½œæˆã•ã‚Œã¦ã‹ã‚‰é–‰ã˜ã‚‹ã¾ã§ã®æ™‚é–“ã‚’é›†è¨ˆã™ã‚‹"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["github", "graphql", "typescript"]
published: false
publication: "sprocket"
---

## æ¦‚è¦

é–‹ç™ºãƒãƒ¼ãƒ ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ã—ã¦ã„ã‚‹ã„ãšã‚Šã‚‡ãƒ¼ã§ã™ã€‚
ä»Šå›ã¯é–‹ç™ºãƒãƒ¼ãƒ ã®é–‹ç™ºç”Ÿç”£æ€§ã‚’è¨ˆæ¸¬ã—ã‚ˆã†ã¨ã™ã‚‹ä¸­ã§ã€Githubã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ(ä»¥ä¸‹PR)ãŒä½œæˆã•ã‚Œã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¾ã§ã®æ™‚é–“ã‚’è¨ˆæ¸¬ã—ãŸã„ãªãƒ¼ã¨ãªã£ãŸã®ã§ã€[GithubGraphQLAPI](https://docs.github.com/ja/graphql)ã‚’ä½¿ã£ã¦ã€æŒ‡å®šã—ãŸæœŸé–“ã®PRã‚’å–å¾—ã—ã¦ã€ãã‚Œã‚‰ãŒä½œæˆã•ã‚Œã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¾ã§ã®æ™‚é–“ã®å¹³å‡ã‚’å–å¾—ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

## å¿…è¦ãªã‚‚ã®

- Githubã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹Token
  - ä»Šå›ã¯Personal Access Tokenã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€ãã‚Œä»¥å¤–ã®æ–¹æ³•ã®å ´åˆã¯èªè¨¼ã™ã‚‹éƒ¨åˆ†ã‚’ç½®ãæ›ãˆã¦ãã ã•ã„

## ç°¡å˜ã«ä»•æ§˜ã‚’ã¾ã¨ã‚ã‚‹

- ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã‚‹
- ãƒªãƒã‚¸ãƒˆãƒªåã¨é›†è¨ˆã™ã‚‹æœŸé–“ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ¸¡ã›ã‚‹
- æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã®PRã‚’å–å¾—ã™ã‚‹
- å–å¾—ã—ãŸPRã®ä½œæˆæ™‚é–“ã¨ãƒãƒ¼ã‚¸ã•ã‚ŒãŸæ™‚é–“ã‹ã‚‰PRãŒã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚Œã¦ã„ãŸæ™‚é–“ã®å¹³å‡ã‚’å‡ºåŠ›ã™ã‚‹

## ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã‚‹ / ãƒªãƒã‚¸ãƒˆãƒªåã¨é›†è¨ˆã™ã‚‹æœŸé–“ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ¸¡ã›ã‚‹

- [node-getopt](https://github.com/jiangmiao/node-getopt)ã‚’åˆ©ç”¨ã—ã¾ã™
- npxã§å®Ÿè¡Œã—ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¦åˆ©ç”¨ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
- ã“ã‚“ãªæ„Ÿã˜ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¨­å®šãŒã§ãã¾ã™

```ts
import Getopt from "node-getopt";

const getopt = new Getopt([
  ["r", "repository", "target repository name"],
  ["s", "start_date=YYYY-MM-DD", "start date (YYYY-MM-DD)"],
  ["e", "end_date=YYYY-MM-DD", "end date (YYYY-MM-DD)"],
  ["h", "help", "display this help"],
]).bindHelp();
const opt = getopt.parseSystem();
```

## æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã®PRã‚’å–å¾—ã™ã‚‹

- GithubGraphQLAPIã«ã¯æœŸé–“ã‚’æŒ‡å®šã—ã¦PRã‚’å–å¾—ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãªã„ã®ã§ã€ä½œæˆã•ã‚ŒãŸæ™‚é–“ã®é™é †ã§PRã‚’50ä»¶ãšã¤å–å¾—ã—ã¦ã€æœŸé–“å†…ã®PRã‚’ä¿æŒã—ã¤ã¤ã€æœŸé–“å¤–ã«ãªã‚‹ã¾ã§å‘¼ã³å‡ºã™å†å¸°é–¢æ•°ã‚’å®Ÿè£…ã—ã¾ã—ãŸ

```ts
const getPullReqeusts = async (args?: {
  pullRequests: GetPullRequestsResult["repository"]["pullRequests"]["nodes"];
  continueInfo: {
    isContinue: boolean;
    nextCursor: string;
  };
}): Promise<GetPullRequestsResult["repository"]["pullRequests"]["nodes"]> => {
  if (args && !args.continueInfo.isContinue) {
    return args.pullRequests;
  }

  const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

  const query = `
    query (
      $repoName: String!,
      $owner: String!
    ){
      repository(owner: $owner, name: $repoName) {
        pullRequests(first: 50, orderBy: {field: CREATED_AT, direction: DESC}, states: [MERGED]) {
          nodes {
            number
            title
            url
            createdAt
            updatedAt
            mergedAt
            author {
              login
            }
            assignees (first: 5) {
              nodes {
                login
              }
            }
            additions
            deletions
          }
          pageInfo {
            startCursor
            endCursor
            hasNextPage
            hasPreviousPage
          }
        }
      }
    }
  `;

  const { repository } = await octokit.graphql<GetPullRequestsResult>(query, {
    owner: "sprocket-inc",
    repoName: repositoryName,
  });
  const { nodes, pageInfo } = repository.pullRequests;

  const pullRequests = args?.pullRequests ?? [];
  nodes.forEach((n) => {
    if (
      isBefore(startDate, new Date(n.createdAt)) &&
      isAfter(endDate, new Date(n.createdAt))
    ) {
      pullRequests.push(n);
    }
  });

  const isContinue = isBefore(
    startDate,
    new Date(nodes[nodes.length - 1].createdAt)
  );

  return await getPullReqeusts({
    pullRequests,
    continueInfo: {
      isContinue,
      nextCursor: pageInfo.endCursor,
    },
  });
};
```

### queryã®èª¬æ˜

- ã“ã“ã§å–å¾—ã—ã¦ã„ã‚‹PRã®ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã§ã™
  - è©³ã—ãã¯[ã“ã¡ã‚‰](https://docs.github.com/ja/graphql/reference/objects#repository)ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã™

|é …ç›®å|ä½•ã‹|
|-- |-- |
| nodes.number | PRç•ªå· |
| nodes.title | ã‚¿ã‚¤ãƒˆãƒ« |
| nodes.url | PRã®URL |
| nodes.createdAt | ä½œæˆæ™‚åˆ» |
| nodes.updatedAt | æœ€çµ‚æ›´æ–°æ™‚åˆ» |
| nodes.mergedAt | ãƒãƒ¼ã‚¸ã•ã‚ŒãŸæ™‚åˆ» |
| nodes.author.login | PRä½œæˆè€… |
| nodes.assignees.nodes.login | ã‚¢ã‚µã‚¤ãƒ³ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆ |
| nodes.additions | è¿½åŠ ã•ã‚ŒãŸè¡Œæ•° |
| nodes.deletions | å‰Šé™¤ã•ã‚ŒãŸè¡Œæ•° |
| pageInfo.startCursor | å–å¾—ã—ãŸPRã®1ç•ªç›®ã®Cursor |
| pageInfo.endCursor | å–å¾—ã—ãŸPRã®æœ€å¾Œã®Cursor |
| pageInfo.hasNextPage | æ¬¡ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ |
| pageInfo.hasPreviousPage | å‰ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ |

### å–å¾—ã—ãŸPRã®ä½œæˆæ™‚é–“ã¨ãƒãƒ¼ã‚¸ã•ã‚ŒãŸæ™‚é–“ã‹ã‚‰PRãŒã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚Œã¦ã„ãŸæ™‚é–“ã®å¹³å‡ã‚’å‡ºåŠ›ã™ã‚‹

- å…ˆã»ã©å–å¾—ã—ãŸPRã‚’ forEach ã§å›ã—ãªãŒã‚‰ create â†’ merge ã¾ã§ã®æ™‚é–“ã‚’å–å¾—ã—ã¦ã„ãã¾ã™
- é›†è¨ˆã™ã‚‹å˜ä½ã¯ã€Œæ—¥ã€ã¨ã€Œæ™‚é–“ã€ã«ã—ã¦ã„ã¾ã™

```ts
  const { repository } = await octokit.graphql<GetPullRequestsResult>(query, {
    owner: "sprocket-inc",
    repoName: repositoryName,
  });
  const { nodes, pageInfo } = repository.pullRequests;

  const pullRequests = args?.pullRequests ?? [];
  nodes.forEach((n) => {
    if (
      isBefore(startDate, new Date(n.createdAt)) &&
      isAfter(endDate, new Date(n.createdAt))
    ) {
      pullRequests.push(n);
    }
  });

  const isContinue = isBefore(
    startDate,
    new Date(nodes[nodes.length - 1].createdAt)
  );

  return await getPullReqeusts({
    pullRequests,
    continueInfo: {
      isContinue,
      nextCursor: pageInfo.endCursor,
    },
  });
```

## å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰

::::details ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰
:::message

```ts
import Getopt from "node-getopt";
import dotenv from "dotenv";
import { Octokit } from "octokit";
import { differenceInSeconds, isAfter, isBefore, endOfDay } from "date-fns";

dotenv.config();

const getopt = new Getopt([
  ["r", "repository", "target repository name"],
  ["s", "start_date=YYYY-MM-DD", "start date (YYYY-MM-DD)"],
  ["e", "end_date=YYYY-MM-DD", "end date (YYYY-MM-DD)"],
  ["h", "help", "display this help"],
]).bindHelp();
const opt = getopt.parseSystem();

const repositoryName = opt.options.repository;

if (!repositoryName || !opt.options.start_date || !opt.options.end_date) {
  getopt.showHelp();
  process.exit(1);
}
const startDate = new Date(String(opt.options.start_date) ?? "");
const endDate = endOfDay(new Date(String(opt.options.end_date) ?? ""));

type PullRequestItem = {
  number: number;
  title: string;
  url: string;
  createdAt: string;
  mergedAt: string;
  author: {
    login: string;
  };
  additions: number;
  deletions: number;
};

type PageInfo = {
  startCursor: string;
  endCursor: string;
  hasNextPage: boolean;
  hasPreviousPage: boolean;
};

type GetPullRequestsResult = {
  repository: {
    pullRequests: {
      nodes: PullRequestItem[];
      pageInfo: PageInfo;
    };
  };
};

const getPullReqeusts = async (args?: {
  pullRequests: GetPullRequestsResult["repository"]["pullRequests"]["nodes"];
  continueInfo: {
    isContinue: boolean;
    nextCursor: string;
  };
}): Promise<GetPullRequestsResult["repository"]["pullRequests"]["nodes"]> => {
  if (args && !args.continueInfo.isContinue) {
    return args.pullRequests;
  }

  const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

  const query = `
    query (
      $repoName: String!,
      $owner: String!
    ){
      repository(owner: $owner, name: $repoName) {
        pullRequests(first: 50, orderBy: {field: CREATED_AT, direction: DESC}, states: [MERGED]) {
          nodes {
            number
            title
            url
            createdAt
            updatedAt
            mergedAt
            author {
              login
            }
            assignees (first: 5) {
              nodes {
                login
              }
            }
            additions
            deletions
          }
          pageInfo {
            startCursor
            endCursor
            hasNextPage
            hasPreviousPage
          }
        }
      }
    }
  `;

  const { repository } = await octokit.graphql<GetPullRequestsResult>(query, {
    owner: "sprocket-inc",
    repoName: repositoryName,
  });
  const { nodes, pageInfo } = repository.pullRequests;

  const pullRequests = args?.pullRequests ?? [];
  nodes.forEach((n) => {
    if (
      isBefore(startDate, new Date(n.createdAt)) &&
      isAfter(endDate, new Date(n.createdAt))
    ) {
      pullRequests.push(n);
    }
  });

  const isContinue = isBefore(
    startDate,
    new Date(nodes[nodes.length - 1].createdAt)
  );

  return await getPullReqeusts({
    pullRequests,
    continueInfo: {
      isContinue,
      nextCursor: pageInfo.endCursor,
    },
  });
};

const calculateAverage = (numbers: number[]): number => {
  if (numbers.length === 0) return 0;

  const sum = numbers.reduce(
    (accumulator, currentValue) => accumulator + currentValue,
    0
  );
  const average = sum / numbers.length;
  return parseFloat(average.toFixed(2));
};

(async () => {
  const pullRequests = await getPullReqeusts();

  const resultList: Array<
    PullRequestItem & { diffHour: number; diffDay: number }
  > = [];

  const diffHours: number[] = [];
  const diffDays: number[] = [];

  pullRequests.forEach((pr) => {
    const createdAt = new Date(pr.createdAt);
    const mergedAt = new Date(pr.mergedAt);
    const diffSecond = differenceInSeconds(mergedAt, createdAt);
    const diffHour = Math.floor((diffSecond / (60 * 60)) * 100) / 100;
    const diffDay = Math.floor((diffHour / 24) * 100) / 100;

    diffHours.push(diffHour);
    diffDays.push(diffDay);

    resultList.push({ ...pr, diffHour, diffDay });
  });

  const diffHoursAverage = calculateAverage(diffHours);
  const diffDaysAverage = calculateAverage(diffDays);

  console.log(
    JSON.stringify({ resultList, diffHoursAverage, diffDaysAverage })
  );
})();

/**
 * How to use
 *
 * npx ts-node src/main.ts -r admin-web -s 2024-07-04 -e 2024-07-17 > result.json
 */

```

:::
::::

## ã¾ã¨ã‚

GithubGraphQLAPIã‚’ä½¿ã£ã¦PRã‚’å–å¾—ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚
ã“ã‚Œã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§æŒ‡å®šã—ãŸæœŸé–“ã®PRãŒä½œæˆã•ã‚Œã¦ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¾ã§ã®æ™‚é–“ã®å¹³å‡ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã“ã“ã‹ã‚‰è¤‡æ•°ã®ãƒªãƒã‚¸ãƒˆãƒªã®PRã‚’ã¾ã¨ã‚ã¦é›†è¨ˆã§ãã‚‹ã‚ˆã†ã«ã—ãŸã‚Šã€ã•ã‚‰ã«ä»–ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆã§ãã‚‹ã‚ˆã†ãªæ‹¡å¼µã‚’ã—ã¦ã„ã“ã†ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚
